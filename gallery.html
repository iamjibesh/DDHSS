<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-TWMKWTSFD6"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-TWMKWTSFD6");
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap link -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Bootstrap icon link -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <!-- Popup style -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css"
    />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,200;0,400;0,600;0,800;1,200;1,400;1,600;1,800&display=swap"
      rel="stylesheet"
    />

    <!-- Local css -->
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="gallery-style.css" />

    <!-- Favicon -->
    <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
    <title>Gallery - DDHSS</title>
  </head>
  <body>
    <!-- Navbar -->
    <nav
      class="navbar fixed-top navbar-expand-lg bg-body-tertiary position-sticky"
    >
      <div class="container-fluid">
        <div class="logo-section">
          <a href="index.html">
            <img
              class="logo"
              src="images/logo.png"
              alt="logo of Dhepdhepi HS School"
            />
          </a>
          <a class="navbar-brand" href="index.html">DDHSS</a>
        </div>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0 w-100 text-center">
            <li class="nav-item ms-lg-auto">
              <a class="nav-link" aria-current="page" href="index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="gallery.html">Gallery</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="faculty.html">Faculty</a>
            </li>
            <!-- Dropdown -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                More
              </a>
              <div
                class="dropdown-menu text-center"
                aria-labelledby="navbarDropdown"
              >
                <a class="dropdown-item" href="notifications.html"
                  >Notifications</a
                >
                <a class="dropdown-item" href="downloads.html">Downloads</a>
                <a class="dropdown-item" href="calender.html"
                  >Holiday Calendar</a
                >
              </div>
            </li>
            <!-- Dropdown Ends -->

            <li class="nav-item">
              <a class="nav-link" href="index.html#contact-us">Contact Us</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Header Section -->
    <div
      class="gallery-header"
      style="
        background: #2a7b9b;
        background: linear-gradient(
          90deg,
          rgba(42, 123, 155, 1) 0%,
          rgba(87, 199, 133, 1) 50%,
          rgba(237, 221, 83, 1) 100%
        );
      "
    >
      <h2 style="font-size: 40px">Gallery</h2>
    </div>

    <main class="mainContainer">
      <!--  *****  Buttons Section Starts  *****  -->
      <div class="button-group">
        <button class="button active" data-filter="*">All</button>
      </div>
      <!--  *****  Buttons Section Ends  *****  -->

      <!--  *****  Gallery Section Starts  *****  -->
      <div class="gallery-page">
        <div style="text-align: center; width: 100%; padding: 20px">
          Loading Gallery...
        </div>
      </div>

      <!--  *****  Gallery Section Ends  *****  -->
    </main>

    <!-- Footer Section -->
    <section class="footer">
      <div class="footer-container">
        <div class="social">
          <a
            target="_blank"
            rel="noopener noreferrer"
            href="https://www.facebook.com/share/g/14sbGfnjdY/"
            ><i class="bi bi-facebook"></i
          ></a>
          <a href="mailto:dhepdhepihs@gmail.com"
            ><i class="bi bi-envelope-at-fill"></i
          ></a>
        </div>
        <div class="copyright">
          <p class="copyright-text mt-3 mb-0">
            © Copyright <span id="year"></span> DDHSS
          </p>
        </div>
        <div class="love">
          <p>
            Made with ❤ by
            <a
              target="_blank"
              rel="noopener noreferrer"
              href="https://www.facebook.com/jibeshsaha"
              >Jibesh Saha</a
            >
          </p>
        </div>
      </div>
    </section>

    <!-- Footer Javascript -->
    <script>
      // Get the current year automatically
      document.getElementById("year").textContent = new Date().getFullYear();
    </script>

    <!-- Bootstrap Javascript -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <!-- Lightbox Popup -->
    <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
    <!--   *****   JQuery Link   *****   -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>

    <!-- Isotope needs this tool to stop images from stacking on top of each other while loading. -->
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>

    <!--   *****   Isotope Filter Link   *****  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js"></script>

    <script>
      // PASTE YOUR GALLERY SHEET TSV LINK HERE
      const gallerySheetUrl =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vRgcu3dDPgphQLLaq5WEfM2zsIGo-ulFngpWWP0gcyGB86ST8ad2mhZsBv4L5gETX_jEgzCRMZHElUT/pub?output=tsv";

      // CONFIGURATION
      const BATCH_SIZE = 12; // Must be large enough to hold 2 of each category (e.g. 4 categories * 2 = 8 images)

      // Global variables
      let allGalleryData = [];
      let currentCount = 0;
      let $isotopeGrid;
      let lightboxInstance;

      document.addEventListener("DOMContentLoaded", function () {
        fetchGallery();
      });

      async function fetchGallery() {
        const galleryContainer = document.querySelector(".gallery-page");
        const buttonContainer = document.querySelector(".button-group");

        try {
          // 1. Loading State
          galleryContainer.innerHTML =
            '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p>Loading Gallery...</p></div>';

          // 2. Fetch Data (1-minute cache)
          const cacheBuster = Math.floor(Date.now() / 60000);
          const response = await fetch(gallerySheetUrl + "&t=" + cacheBuster);
          if (!response.ok) throw new Error("Network response was not ok");

          const data = await response.text();
          let rows = data.split("\n").slice(1);

          // 3. SHUFFLE RAW DATA FIRST (To ensure randomness)
          for (let i = rows.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [rows[i], rows[j]] = [rows[j], rows[i]];
          }

          // 4. SMART SORTING (The New Logic)
          let tempAllItems = [];
          let uniqueCategories = new Set();
          let categoryCounts = {}; // Track how many we picked for each category

          // Step A: Parse everything into objects first
          rows.forEach((row) => {
            const cols = row.split("\t");
            if (cols.length >= 2) {
              const rawCategory = cols[0].trim();
              const category = rawCategory.toLowerCase();
              const imgLink = cols[1].trim();

              if (category && imgLink) {
                if (category !== "") uniqueCategories.add(rawCategory);
                tempAllItems.push({ category, rawCategory, imgLink });
              }
            }
          });

          // Step B: Separate into "Priority" (First 2 of each) and "Remainder"
          let priorityItems = [];
          let remainderItems = [];

          tempAllItems.forEach((item) => {
            // Initialize count if not exists
            if (!categoryCounts[item.category])
              categoryCounts[item.category] = 0;

            // If we haven't picked 2 for this category yet, make it Priority
            if (categoryCounts[item.category] < 2) {
              priorityItems.push(item);
              categoryCounts[item.category]++;
            } else {
              remainderItems.push(item);
            }
          });

          // Step C: Shuffle Priority Items (So the top of gallery doesn't look sorted)
          for (let i = priorityItems.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [priorityItems[i], priorityItems[j]] = [
              priorityItems[j],
              priorityItems[i],
            ];
          }

          // Step D: Combine back into Main Data
          // Priority items come FIRST, so they load immediately
          allGalleryData = [...priorityItems, ...remainderItems];

          // 5. SETUP UI
          galleryContainer.innerHTML = "";

          // Generate Filter Buttons
          const allBtn = buttonContainer.querySelector('[data-filter="*"]');
          buttonContainer.innerHTML = "";
          buttonContainer.appendChild(allBtn);

          uniqueCategories.forEach((catName) => {
            const filterVal = "." + catName.toLowerCase();
            const btnHTML = `<button class="button" data-filter="${filterVal}">${catName}</button>`;
            buttonContainer.insertAdjacentHTML("beforeend", btnHTML);
          });

          // Initialize Isotope
          $isotopeGrid = $(".gallery-page").isotope({
            itemSelector: ".item",
            layoutMode: "fitRows",
          });

          // Connect Filter Buttons
          $(".button-group")
            .off("click")
            .on("click", "button", function () {
              $(".button-group .button").removeClass("active");
              $(this).addClass("active");
              var value = $(this).attr("data-filter");
              $isotopeGrid.isotope({ filter: value });
            });

          // Create Load More Button (if needed)
          let loadMoreBtn = document.getElementById("load-more-container");
          if (!loadMoreBtn) {
            loadMoreBtn = document.createElement("div");
            loadMoreBtn.id = "load-more-container";
            loadMoreBtn.className = "text-center my-4";
            loadMoreBtn.innerHTML = `<button class="btn btn-primary px-4 py-2">Load More Photos</button>`;
            galleryContainer.parentNode.insertBefore(
              loadMoreBtn,
              galleryContainer.nextSibling
            );

            loadMoreBtn
              .querySelector("button")
              .addEventListener("click", () => {
                loadNextBatch();
              });
          }

          // 6. RESET COUNT AND LOAD FIRST BATCH
          currentCount = 0;
          loadNextBatch();
        } catch (error) {
          console.error("Error:", error);
          galleryContainer.innerHTML = `<p class="text-danger text-center">Failed to load gallery.</p>`;
        }
      }

      function loadNextBatch() {
        if (currentCount >= allGalleryData.length) {
          const btn = document.getElementById("load-more-container");
          if (btn) btn.style.display = "none";
          return;
        }

        const nextBatch = allGalleryData.slice(
          currentCount,
          currentCount + BATCH_SIZE
        );
        let htmlBuffer = "";

        nextBatch.forEach((item) => {
          htmlBuffer += `
                <div class="item ${item.category}">
                    <a href="${item.imgLink}" class="glightbox" data-gallery="school-gallery">
                        <img src="${item.imgLink}" alt="Gallery Image">
                    </a>
                </div>
            `;
        });

        let $newItems = $(htmlBuffer);

        // Append to Isotope
        $(".gallery-page").append($newItems).isotope("appended", $newItems);

        // Wait for images to load
        $newItems.imagesLoaded(function () {
          $isotopeGrid.isotope("layout");

          // Re-init Lightbox for new items
          lightboxInstance = GLightbox({
            selector: ".glightbox",
            touchNavigation: true,
            loop: true,
            autoplayVideos: true,
          });
        });

        currentCount += BATCH_SIZE;

        const btnContainer = document.getElementById("load-more-container");
        if (btnContainer) {
          if (currentCount >= allGalleryData.length) {
            btnContainer.style.display = "none";
          } else {
            btnContainer.style.display = "block";
          }
        }
      }
    </script>
  </body>
</html>
